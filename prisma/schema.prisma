// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String? // Optional for passwordless/PIN users
  pin      String? // Hashed 4-digit PIN for quick login
  image    String?
  role     String  @default("EMPLOYEE") // Will migrate to Enum in next step, keeping string for now to avoid breaking existing data immediately, but logic will use Enum values: FRANCHISOR, FRANCHISEE, MANAGER, SHIFT_SUPERVISOR, EMPLOYEE

  // Permissions - Now role-based with overrides
  customPermissions String? // Stored as JSON string for SQLite compatibility if needed, or use Json type if supported. Prisma SQLite supports Json.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Employee Permissions (configurable by franchise owner)
  canAddServices     Boolean @default(false) // Can create/edit services
  canAddProducts     Boolean @default(false) // Can create/edit products
  canManageInventory Boolean @default(false) // Can update stock levels
  canViewReports     Boolean @default(false) // Can access reports dashboard
  canProcessRefunds  Boolean @default(false) // Can refund transactions
  canManageSchedule  Boolean @default(false) // Can create/edit employee schedules
  canManageEmployees Boolean @default(false) // Can add/edit employees

  // Shift Management Permissions
  canManageShifts Boolean @default(false) // Can open/close cash drawer shifts
  canClockIn      Boolean @default(true) // Can clock in for work
  canClockOut     Boolean @default(true) // Can clock out from work

  // Relations
  franchiseId String?
  franchise   Franchise? @relation(fields: [franchiseId], references: [id])
  locationId  String?
  location    Location?  @relation(fields: [locationId], references: [id])

  franchisor   Franchisor?   @relation("FranchisorOwner")
  magicLinks   MagicLink[]
  appointments Appointment[] // As employee
  schedules    Schedule[]

  // Community
  posts                 Post[]
  comments              Comment[]
  votes                 Vote[]
  badges                UserBadge[]
  processedTransactions Transaction[]         @relation("ProcessedTransactions")
  performedServices     TransactionLineItem[] @relation("PerformedServices")
  activeCart            ActiveCart?

  // New Relations
  timeEntries        TimeEntry[]
  commissionRuleId   String?
  commissionRule     CommissionRule?     @relation(fields: [commissionRuleId], references: [id])
  cashDrawerSessions CashDrawerSession[]
  // Global Catalog (Centralized Management)
  globalServices     GlobalService[]
  globalProducts     GlobalProduct[]
}

model Franchise {
  id           String     @id @default(cuid())
  name         String
  slug         String     @unique // e.g. "aura-salon"
  franchisorId String
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])

  users             User[]
  locations         Location[]
  services          Service[]
  serviceCategories ServiceCategory[]
  products          Product[]
  transactions      Transaction[]

  royaltyRecords    RoyaltyRecord[]
  splitPayoutConfig SplitPayoutConfig?
  membershipPlans   MembershipPlan[]
  suppliers         Supplier[]
  purchaseOrders    PurchaseOrder[]
  commissionRules   CommissionRule[]
  loyaltyProgram    LoyaltyProgram?
  giftCards         GiftCard[]
  discounts         Discount[]
  clients           Client[]
  reviews           Review[]

  settings FranchiseSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Franchise-specific settings for pricing and features
model FranchiseSettings {
  id          String    @id @default(cuid())
  franchiseId String    @unique
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  // Pricing Model Configuration
  pricingModel      String  @default("DUAL_PRICING") // STANDARD, DUAL_PRICING
  cardSurchargeType String  @default("PERCENTAGE") // PERCENTAGE, FLAT_AMOUNT
  cardSurcharge     Decimal @default(3.99) // Percentage (e.g., 3.99 for 3.99%) or flat amount (e.g., 0.50 for $0.50)

  // Display Options
  showDualPricing Boolean @default(true) // Show both cash/card prices

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Location {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique // e.g. "aura-downtown"
  address     String?
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  users              User[]
  terminals          Terminal[]
  purchaseOrders     PurchaseOrder[]
  stockAdjustments   StockAdjustment[]
  timeEntries        TimeEntry[]
  cashDrawerSessions CashDrawerSession[]
  appointments       Appointment[]
  schedules          Schedule[]

  // Payment Processor Configuration
  processorName   String? // e.g., "DATAWIRE", "TSYS", "VANTIV", "WORLDPAY", "FIRST_DATA"
  processorMID    String? // Merchant ID from processor
  processorTID    String? // Terminal ID from processor
  processorVAR    String? // VAR/Reseller ID (if applicable)
  paxTerminalIP   String? // PAX device IP address
  paxTerminalPort String  @default("10009") // PAX device port

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ GLOBAL CATALOG (FRANCHISOR MANAGED) ============

model GlobalService {
  id           String     @id @default(cuid())
  franchisorId String
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])

  name         String
  description  String?
  duration     Int // in minutes
  defaultPrice Decimal
  category     String?
  isArchived   Boolean @default(false)

  // Relations: One global service spawns many local instances
  localInstances Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

model GlobalProduct {
  id           String     @id @default(cuid())
  franchisorId String
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])

  name         String
  description  String?
  defaultPrice Decimal
  defaultCost  Decimal?
  sku          String?
  category     String?
  isArchived   Boolean  @default(false)

  localInstances Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

// ============ LOCAL INSTANCES ============

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)

  services Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id              String           @id @default(cuid())
  name            String
  description     String?
  duration        Int // in minutes
  price           Decimal
  category        String? // Deprecated - keeping for backward compatibility
  categoryId      String? // New: Link to ServiceCategory
  serviceCategory ServiceCategory? @relation(fields: [categoryId], references: [id])
  franchiseId     String
  franchise       Franchise        @relation(fields: [franchiseId], references: [id])

  // Link to Global Catalog (Optional - allows for local-only services too)
  globalServiceId String?
  globalService   GlobalService? @relation(fields: [globalServiceId], references: [id])

  appointments         Appointment[]
  transactionLineItems TransactionLineItem[]
}

model Client {
  id        String  @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?

  liabilitySigned Boolean @default(false)
  loyaltyJoined   Boolean @default(false)

  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  appointments Appointment[]
  memberships  ClientMembership[]
  loyalty      ClientLoyalty?
  transactions Transaction[]
  reviews      Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Appointment {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  startTime DateTime
  endTime   DateTime
  status    String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Schedule {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  date      DateTime // The date of the shift
  startTime DateTime
  endTime   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Products for retail sale
model Product {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  name        String
  description String?
  price       Decimal
  cost        Decimal? // Cost to franchise
  stock       Int      @default(0)
  category    String? // "Hair Care", "Styling Products", etc.
  sku         String?
  isActive    Boolean  @default(true)

  // Link to Global Catalog
  globalProductId String?
  globalProduct   GlobalProduct? @relation(fields: [globalProductId], references: [id])

  lineItems TransactionLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // New Relations
  suppliers          ProductSupplier[]
  purchaseOrderItems PurchaseOrderItem[]
  stockAdjustments   StockAdjustment[]
}

// POS Transaction (sale/checkout)
model Transaction {
  id            String    @id @default(cuid())
  invoiceNumber String?   @unique // Sequential invoice number for IRS compliance
  franchiseId   String
  franchise     Franchise @relation(fields: [franchiseId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  employeeId String? // Who processed the sale
  employee   User?   @relation("ProcessedTransactions", fields: [employeeId], references: [id])

  subtotal Decimal
  tax      Decimal @default(0)
  tip      Decimal @default(0)
  discount Decimal @default(0)
  cardFee  Decimal @default(0) // Card processing fee if applicable
  total    Decimal

  paymentMethod  String // CASH, DEBIT_CARD, CREDIT_CARD, SPLIT
  processingPlan String? // STANDARD, SURCHARGE, DUAL_PRICE (from merchant config)

  // Split Payment Fields
  cashAmount Decimal @default(0) // Amount paid in cash (for SPLIT payments)
  cardAmount Decimal @default(0) // Amount paid by card (for SPLIT payments)

  // PAX / Gateway Details
  gatewayTxId String? // Transaction ID from PAX/Processor
  authCode    String? // Authorization Code
  cardLast4   String? // Last 4 digits of card
  cardType    String? // Visa, MasterCard, etc.

  status String @default("COMPLETED") // COMPLETED, REFUNDED, VOIDED

  cashDrawerSessionId String?
  cashDrawerSession   CashDrawerSession? @relation(fields: [cashDrawerSessionId], references: [id])

  // Refund Linking
  originalTransactionId String?
  originalTransaction   Transaction?  @relation("RefundRelation", fields: [originalTransactionId], references: [id])
  refunds               Transaction[] @relation("RefundRelation")

  lineItems TransactionLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Line items in a transaction
model TransactionLineItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  type String // SERVICE, PRODUCT

  // If service
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])
  staffId   String? // Who performed the service
  staff     User?    @relation("PerformedServices", fields: [staffId], references: [id])

  // If product
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)

  price    Decimal // Price per item
  discount Decimal @default(0)
  total    Decimal // Total for this line item

  createdAt DateTime @default(now())
}

// Royalty Configuration (customizable by each franchisor)
model RoyaltyConfig {
  id           String     @id @default(cuid())
  franchisorId String     @unique
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])

  percentage        Decimal // e.g., 6.0 for 6%
  minimumMonthlyFee Decimal? // Optional minimum fee
  calculationPeriod String   @default("MONTHLY") // MONTHLY, WEEKLY, DAILY

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Royalty Records (calculated periodically)
model RoyaltyRecord {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  periodStart DateTime
  periodEnd   DateTime

  grossRevenue  Decimal // Total revenue for period
  royaltyAmount Decimal // Calculated royalty
  status        String  @default("PENDING") // PENDING, PAID, OVERDUE

  paidAt DateTime?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Real-time POS Mirroring
model ActiveCart {
  id     String @id @default(cuid())
  userId String @unique // The employee operating the POS
  user   User   @relation(fields: [userId], references: [id])

  items    String // JSON string of cart items
  subtotal Decimal
  tax      Decimal
  total    Decimal

  customerName String? // To show "Hi, John" on display
  status       String  @default("IDLE") // IDLE, ACTIVE, REVIEW

  updatedAt DateTime @updatedAt
}

// ============ FINTECH & PAYMENTS (PAX INTEGRATION) ============

model Terminal {
  id           String   @id @default(cuid())
  serialNumber String   @unique
  model        String // e.g., "PAX A920"
  locationId   String
  location     Location @relation(fields: [locationId], references: [id])
  status       String   @default("ONLINE") // ONLINE, OFFLINE, ERROR
  ipAddress    String?
  macAddress   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SplitPayoutConfig {
  id          String    @id @default(cuid())
  franchiseId String    @unique
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  isEnabled        Boolean @default(false) // OPTIONAL as requested
  royaltyPercent   Decimal // e.g., 6.0
  marketingPercent Decimal @default(0)

  // Banking info for routing (encrypted in real app)
  franchisorAccountId String?
  franchiseeAccountId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ MEMBERSHIPS & RECURRING REVENUE ============

model MembershipPlan {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  name            String // e.g., "VIP Gold"
  price           Decimal
  billingInterval String // MONTHLY, YEARLY
  description     String?

  // Perks
  discountPercent  Decimal @default(0)
  includedServices String? // JSON list of service IDs

  isActive    Boolean            @default(true)
  memberships ClientMembership[]
  createdAt   DateTime           @default(now())
}

model ClientMembership {
  id       String         @id @default(cuid())
  clientId String
  client   Client         @relation(fields: [clientId], references: [id])
  planId   String
  plan     MembershipPlan @relation(fields: [planId], references: [id])

  status          String   @default("ACTIVE") // ACTIVE, CANCELLED, PAST_DUE
  startDate       DateTime @default(now())
  nextBillingDate DateTime
  paymentMethodId String? // Tokenized card ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ ADVANCED INVENTORY & SUPPLY CHAIN ============

model Supplier {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?

  products       ProductSupplier[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
}

model ProductSupplier {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  cost Decimal
  sku  String?

  @@unique([productId, supplierId])
}

model PurchaseOrder {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])
  supplierId  String
  supplier    Supplier  @relation(fields: [supplierId], references: [id])

  status       String    @default("DRAFT") // DRAFT, ORDERED, RECEIVED, CANCELLED
  totalCost    Decimal
  expectedDate DateTime?

  items PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  productId       String
  product         Product       @relation(fields: [productId], references: [id])

  quantity  Int
  unitCost  Decimal
  totalCost Decimal
}

model StockAdjustment {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  quantity Int // Positive (add) or Negative (remove)
  reason   String // "SALE", "RESTOCK", "DAMAGE", "THEFT", "TRANSFER"
  notes    String?

  performedBy String
  createdAt   DateTime @default(now())
}

// ============ WORKFORCE MANAGEMENT ============

model TimeEntry {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  clockIn       DateTime
  clockOut      DateTime?
  breakDuration Int       @default(0) // in minutes

  totalHours Decimal?
  status     String   @default("OPEN") // OPEN, CLOSED, APPROVED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommissionRule {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  name           String // e.g., "Senior Stylist Tier"
  servicePercent Decimal // e.g., 40.0
  productPercent Decimal // e.g., 10.0

  users User[]

  createdAt DateTime @default(now())
}

// ============ LOYALTY & GIFT CARDS ============

model LoyaltyProgram {
  id          String    @id @default(cuid())
  franchiseId String    @unique
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  isEnabled       Boolean @default(true)
  pointsPerDollar Decimal @default(1.0)
  redemptionRatio Decimal @default(0.01) // 100 points = $1.00

  createdAt DateTime @default(now())
}

model ClientLoyalty {
  id       String @id @default(cuid())
  clientId String @unique
  client   Client @relation(fields: [clientId], references: [id])

  pointsBalance  Int @default(0)
  lifetimePoints Int @default(0)

  updatedAt DateTime @updatedAt
}

model GiftCard {
  id          String    @id @default(cuid())
  code        String    @unique
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  initialAmount  Decimal
  currentBalance Decimal

  purchaserId    String?
  recipientEmail String?

  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ CASH MANAGEMENT (SHIFTS) ============

model CashDrawerSession {
  id         String   @id @default(cuid())
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String
  employee   User     @relation(fields: [employeeId], references: [id])

  startTime DateTime  @default(now())
  endTime   DateTime?

  startingCash Decimal
  endingCash   Decimal? // Actual cash counted
  expectedCash Decimal? // Calculated cash (Start + Cash Sales - Drops)
  variance     Decimal? // Ending - Expected

  status String  @default("OPEN") // OPEN, CLOSED
  notes  String?

  cashDrops    CashDrop[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CashDrop {
  id        String            @id @default(cuid())
  sessionId String
  session   CashDrawerSession @relation(fields: [sessionId], references: [id])

  amount    Decimal
  reason    String // "SAFE_DROP", "PAYOUT", "OTHER"
  droppedBy String // Employee ID

  createdAt DateTime @default(now())
}

// ============ PROMOTIONS & DISCOUNTS ============

model Discount {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  name  String
  code  String? // Optional promo code
  type  String // PERCENTAGE, FIXED_AMOUNT
  value Decimal // e.g., 20.0 for 20% or 10.0 for $10

  appliesTo String // ALL, SERVICE, PRODUCT, SPECIFIC_ITEM
  itemIds   String? // JSON array of specific Service/Product IDs if applicable

  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ COMMUNITY & AUTH ============

model MagicLink {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Post {
  id          String  @id @default(cuid())
  title       String
  content     String
  authorId    String
  author      User    @relation(fields: [authorId], references: [id])
  franchiseId String?

  comments Comment[]
  votes    Vote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id       String @id @default(cuid())
  content  String
  postId   String
  post     Post   @relation(fields: [postId], references: [id])
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vote {
  id     String @id @default(cuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id])
  userId String
  user   User   @relation(fields: [userId], references: [id])
  type   String // UPVOTE, DOWNVOTE

  @@unique([postId, userId])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name      String // e.g., "Top Seller", "Early Adopter"
  icon      String?
  awardedAt DateTime @default(now())
}

// ============ REVIEWS ============

model Review {
  id          String    @id @default(cuid())
  franchiseId String
  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Transaction reference (optional - for linking to specific purchase)
  transactionRef String? // Could link to future Transaction model

  rating      Int // 1-5 stars
  feedbackTag String? // Selected feedback tag (e.g., "Amazing service! ‚≠ê")
  comment     String? // Optional text comment

  // Google Business integration (future)
  googleReviewId String? // Google My Business review ID when posted
  postedToGoogle Boolean   @default(false)
  postedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ CRM & FRANCHISOR MANAGEMENT ============

model Franchisor {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation("FranchisorOwner", fields: [userId], references: [id], onDelete: Cascade)

  name String?

  // Business Type
  businessType String @default("MULTI_LOCATION_OWNER") // "BRAND_FRANCHISOR" | "MULTI_LOCATION_OWNER"

  // CRM Relations
  leads       Lead[]
  territories Territory[]

  // Existing Relations
  franchises     Franchise[]
  globalServices GlobalService[]
  globalProducts GlobalProduct[]
  royaltyConfig  RoyaltyConfig?

  // Onboarding Fields
  documentsLater          Boolean?
  processingType          String?
  needToDiscussProcessing Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id           String     @id @default(cuid())
  franchisorId String
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])

  // Lead info
  name    String
  email   String
  phone   String?
  company String?
  city    String?
  state   String?

  // Pipeline
  status     String  @default("NEW") // NEW, CONTACTED, QUALIFIED, PROPOSAL, NEGOTIATION, CLOSED_WON, CLOSED_LOST
  source     String? // WEBSITE, REFERRAL, EVENT, COLD_CALL
  assignedTo String? // Agent ID

  // Financial
  estimatedValue Float?
  proposedFee    Float?

  // Lead Scoring & Intelligence (NEW)
  score           Int?      // 0-100 lead score
  rating          String?   // HOT, WARM, COLD
  probability     Float?    // 0-100% chance to close
  expectedClose   DateTime? // Expected close date
  competitors     String?   // JSON array of competitor names
  painPoints      String?   // JSON array of pain points
  decisionMakers  String?   // JSON array of key stakeholders

  // Activity Tracking (NEW)
  lastActivityAt  DateTime? // Last interaction timestamp
  emailOpens      Int       @default(0) // Email open count
  emailClicks     Int       @default(0) // Email click count
  callCount       Int       @default(0) // Total calls made
  meetingCount    Int       @default(0) // Total meetings

  // Tracking
  lastContact  DateTime?
  nextFollowUp DateTime?
  notes        Note[]
  activities   Activity[]
  tasks        Task[] // NEW relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Note {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  content   String
  category  String?  @default("GENERAL") // GENERAL, FOLLOW_UP, DECISION, RED_FLAG
  isPinned  Boolean  @default(false)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Activity {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String   // CALL, EMAIL, MEETING, NOTE, PROPOSAL_SENT, TASK
  subject   String
  notes     String?
  duration  Int?     // Duration in minutes (for calls/meetings)
  outcome   String?  // POSITIVE, NEUTRAL, NEGATIVE, NO_ANSWER
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Territory {
  id           String     @id @default(cuid())
  franchisorId String
  franchisor   Franchisor @relation(fields: [franchisorId], references: [id])
  name         String
  states       String // JSON array of state codes
  isAvailable  Boolean    @default(true)
  price        Decimal?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  title       String
  description String?
  dueDate     DateTime
  priority    String   @default("MEDIUM") // HIGH, MEDIUM, LOW
  status      String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  assignedTo  String
  completedAt DateTime?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  body      String   // HTML content
  variables String?  // JSON array of available variables
  category  String?  // WELCOME, FOLLOW_UP, PROPOSAL, etc.
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String   // Lead, Note, Activity, Task
  entityId   String
  action     String   // CREATED, UPDATED, DELETED, VIEWED
  userId     String
  changes    String?  // JSON before/after
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}
