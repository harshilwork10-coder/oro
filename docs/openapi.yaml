openapi: 3.0.3
info:
  title: Oronex POS API
  version: 1.0.0
  description: |
    Multi-tenant POS system API for franchise management.
    
    ## Authentication
    All endpoints require session authentication via NextAuth.
    Use Cookie-based sessions with `next-auth.session-token`.
    
    ## Multi-Tenancy
    Data is isolated by `franchiseId`. Users can only access data within their tenant.

servers:
  - url: /api
    description: API routes

tags:
  - name: Auth
    description: Authentication & session management
  - name: POS
    description: Point of Sale transactions
  - name: Products
    description: Product/inventory management
  - name: Employees
    description: Employee management
  - name: Reports
    description: Business reports

paths:
  /auth/pin-login:
    post:
      tags: [Auth]
      summary: PIN-based employee login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pin, locationId]
              properties:
                pin: { type: string, pattern: '^\d{4}$' }
                locationId: { type: string }
                employeeId: { type: string }
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSession'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '429': { $ref: '#/components/responses/RateLimited' }

  /pos/transaction:
    post:
      tags: [POS]
      summary: Create a new sale transaction
      security: [{ sessionAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionCreate'
      responses:
        '200':
          description: Transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '422': { $ref: '#/components/responses/ValidationError' }

  /pos/refund:
    post:
      tags: [POS]
      summary: Process a refund (atomic)
      description: All operations are wrapped in $transaction for rollback safety
      security: [{ sessionAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
      responses:
        '200':
          description: Refund processed
        '403': { $ref: '#/components/responses/Forbidden' }

  /pos/void:
    post:
      tags: [POS]
      summary: Void a transaction
      security: [{ sessionAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [transactionId]
              properties:
                transactionId: { type: string }
                reason: { type: string, minLength: 3 }
      responses:
        '200':
          description: Transaction voided

  /products:
    get:
      tags: [Products]
      summary: List all products for franchise
      security: [{ sessionAuth: [] }]
      responses:
        '200':
          description: Product list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'
    post:
      tags: [Products]
      summary: Create a new product
      security: [{ sessionAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreate'
      responses:
        '200':
          description: Product created
        '422': { $ref: '#/components/responses/ValidationError' }

  /employees:
    get:
      tags: [Employees]
      summary: List employees
      security: [{ sessionAuth: [] }]
      responses:
        '200':
          description: Employee list
    post:
      tags: [Employees]
      summary: Create employee
      description: Creates user with temp password. Audit logged.
      security: [{ sessionAuth: [] }]
      responses:
        '201':
          description: Employee created

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token

  schemas:
    UserSession:
      type: object
      properties:
        success: { type: boolean }
        user:
          type: object
          properties:
            id: { type: string }
            email: { type: string }
            name: { type: string }
            role: { type: string }
            franchiseId: { type: string }
            locationId: { type: string }

    TransactionCreate:
      type: object
      required: [items, subtotal, total, paymentMethod]
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            properties:
              id: { type: string }
              type: { type: string, enum: [SERVICE, PRODUCT] }
              name: { type: string }
              price: { type: number }
              quantity: { type: integer }
              discount: { type: number }
        subtotal: { type: number }
        tax: { type: number }
        total: { type: number }
        tip: { type: number }
        paymentMethod: { type: string, enum: [CASH, CREDIT_CARD, DEBIT_CARD, SPLIT, GIFT_CARD, EBT] }
        clientId: { type: string }
        cashDrawerSessionId: { type: string }

    Transaction:
      type: object
      properties:
        id: { type: string }
        invoiceNumber: { type: string }
        status: { type: string }
        total: { type: number }
        createdAt: { type: string, format: date-time }

    RefundRequest:
      type: object
      required: [originalTransactionId, items]
      properties:
        originalTransactionId: { type: string }
        refundType: { type: string, enum: [FULL, PARTIAL] }
        items:
          type: array
          items:
            type: object
            properties:
              lineItemId: { type: string }
              quantity: { type: integer }
        reason: { type: string }
        refundMethod: { type: string }

    Product:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        sku: { type: string }
        barcode: { type: string }
        price: { type: number }
        stock: { type: integer }
        category: { type: string }

    ProductCreate:
      type: object
      required: [name, price]
      properties:
        name: { type: string, minLength: 1 }
        sku: { type: string }
        barcode: { type: string }
        price: { type: number }
        stock: { type: integer, default: 0 }
        description: { type: string }
        category: { type: string, default: RETAIL }

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              success: { type: boolean, example: false }
              error: { type: string, example: Unauthorized }
              code: { type: string, example: UNAUTHORIZED }

    Forbidden:
      description: Permission denied
      content:
        application/json:
          schema:
            type: object
            properties:
              success: { type: boolean, example: false }
              error: { type: string }
              code: { type: string, example: FORBIDDEN }

    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            type: object
            properties:
              success: { type: boolean, example: false }
              error: { type: string }
              code: { type: string, example: VALIDATION_ERROR }
              details:
                type: array
                items:
                  type: object
                  properties:
                    path: { type: array, items: { type: string } }
                    message: { type: string }

    RateLimited:
      description: Too many requests
      headers:
        Retry-After:
          schema: { type: integer }
      content:
        application/json:
          schema:
            type: object
            properties:
              success: { type: boolean, example: false }
              error: { type: string, example: Too many requests }
              code: { type: string, example: RATE_LIMITED }
